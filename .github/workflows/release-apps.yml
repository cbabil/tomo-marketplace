name: Release

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Create individual app zips from manifest
        run: |
          mkdir -p dist
          node -e "
          const fs = require('fs');
          const { execSync } = require('child_process');
          const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
          manifest.apps.forEach(app => {
            const zipName = app.id + '-' + app.version + '.zip';
            console.log('Creating ' + zipName + '...');
            execSync('cd ' + app.path + ' && zip -r ../../../dist/' + zipName + ' .');
          });
          console.log('All app zips created successfully!');
          "
          ls -la dist/

      - name: Generate release notes file
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="${LAST_TAG}..HEAD"
          fi
          export RANGE
          export TAG

          node -e "
          const fs = require('fs');
          const { execSync } = require('child_process');
          const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
          const tag = process.env.TAG;
          const range = process.env.RANGE;
          const date = new Date().toISOString().split('T')[0];

          let notes = '# Homelab Marketplace ' + tag + '\n\n';
          notes += 'Released: ' + date + '\n\n';
          notes += '## Apps Included\n\n';
          notes += '| App | Version | Category | Download |\n';
          notes += '|-----|---------|----------|----------|\n';

          manifest.apps.forEach(app => {
            const zip = app.id + '-' + app.version + '.zip';
            notes += '| ' + app.name + ' | ' + app.version + ' | ' + app.category + ' | [' + zip + '](' + zip + ') |\n';
          });

          notes += '\n## App Details\n\n';
          manifest.apps.forEach(app => {
            notes += '### ' + app.name + '\n\n';
            notes += app.description + '\n\n';
            notes += '- **Version:** ' + app.version + '\n';
            notes += '- **Category:** ' + app.category + '\n';
            notes += '- **Path:** ' + app.path + '\n\n';
          });

          notes += '## Changelog\n\n';

          try {
            const features = execSync('git log ' + range + ' --pretty=format:\"- %s\" --grep=\"^feat\" 2>/dev/null || true', {encoding: 'utf8'}).trim();
            if (features) {
              notes += '### Features\n' + features + '\n\n';
            }
          } catch(e) {}

          try {
            const fixes = execSync('git log ' + range + ' --pretty=format:\"- %s\" --grep=\"^fix\" 2>/dev/null || true', {encoding: 'utf8'}).trim();
            if (fixes) {
              notes += '### Bug Fixes\n' + fixes + '\n\n';
            }
          } catch(e) {}

          try {
            const others = execSync('git log ' + range + ' --pretty=format:\"- %s\" --grep=\"^chore\" 2>/dev/null || true', {encoding: 'utf8'}).trim();
            if (others) {
              notes += '### Other Changes\n' + others + '\n\n';
            }
          } catch(e) {}

          fs.writeFileSync('dist/RELEASE_NOTES.md', notes);
          console.log(notes);
          "

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release delete "$TAG" -y
            git push origin ":refs/tags/$TAG" || true
          fi

          gh release create "$TAG" dist/*.zip dist/RELEASE_NOTES.md \
            --repo "$GITHUB_REPOSITORY" \
            --title "$TAG" \
            --notes-file dist/RELEASE_NOTES.md \
            --latest
