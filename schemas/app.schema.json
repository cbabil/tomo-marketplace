{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/cbabil/homelab-marketplace/schemas/app.schema.json",
  "title": "Homelab Marketplace App",
  "description": "Schema for app.yaml definitions in the Homelab Marketplace",
  "type": "object",
  "additionalProperties": false,
  "required": ["id", "name", "description", "version", "category", "tags", "icon", "repository", "documentation", "docker", "requirements"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]{1,48}$",
      "minLength": 2,
      "maxLength": 50,
      "description": "Unique lowercase identifier (2-50 chars, lowercase letters, numbers, hyphens)"
    },
    "name": {
      "type": "string",
      "minLength": 2,
      "maxLength": 50,
      "pattern": "^[A-Za-z0-9][A-Za-z0-9 ._-]*$",
      "description": "Display name (2-50 chars, alphanumeric start)"
    },
    "description": {
      "type": "string",
      "minLength": 20,
      "maxLength": 200,
      "pattern": "^[A-Z].*[.!]$",
      "description": "Brief description (20-200 chars, starts with capital, ends with punctuation)"
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "description": "Semantic version (X.Y.Z format)"
    },
    "category": {
      "type": "string",
      "enum": ["automation", "media", "monitoring", "networking", "security", "storage", "utility"],
      "description": "App category"
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[a-z][a-z0-9-]{1,29}$",
        "minLength": 2,
        "maxLength": 30
      },
      "minItems": 1,
      "maxItems": 10,
      "uniqueItems": true,
      "description": "Tags for filtering (1-10 unique tags, lowercase)"
    },
    "icon": {
      "type": "string",
      "format": "uri",
      "pattern": "^https://.*\\.(svg|png|jpg|jpeg|webp|ico)$",
      "description": "HTTPS URL to app icon (svg, png, jpg, webp, ico)"
    },
    "repository": {
      "type": "string",
      "format": "uri",
      "pattern": "^https://(github\\.com|gitlab\\.com|bitbucket\\.org|codeberg\\.org)/.*$",
      "description": "HTTPS URL to source repository (GitHub, GitLab, Bitbucket, Codeberg)"
    },
    "documentation": {
      "type": "string",
      "format": "uri",
      "pattern": "^https://.*$",
      "description": "HTTPS URL to official documentation"
    },
    "docker": {
      "type": "object",
      "additionalProperties": false,
      "required": ["image"],
      "properties": {
        "image": {
          "type": "string",
          "pattern": "^(docker\\.io/|ghcr\\.io/|lscr\\.io/|quay\\.io/|gcr\\.io/|mcr\\.microsoft\\.com/)?[a-z0-9][a-z0-9._/-]*:[a-z0-9][a-z0-9._-]+$",
          "not": {
            "anyOf": [
              { "pattern": ":latest$" },
              { "pattern": ":dev$" },
              { "pattern": ":nightly$" },
              { "pattern": ":edge$" },
              { "pattern": ":unstable$" },
              { "pattern": ":master$" },
              { "pattern": ":main$" }
            ]
          },
          "description": "Docker image from trusted registry with pinned version"
        },
        "ports": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["container", "host", "protocol", "description"],
            "properties": {
              "container": {
                "type": "integer",
                "minimum": 1,
                "maximum": 65535
              },
              "host": {
                "type": "integer",
                "minimum": 1,
                "maximum": 65535,
                "description": "Host port (privileged ports <1024 require root)"
              },
              "protocol": {
                "type": "string",
                "enum": ["tcp", "udp"]
              },
              "description": {
                "type": "string",
                "minLength": 3,
                "maxLength": 100
              }
            }
          },
          "minItems": 1,
          "maxItems": 20
        },
        "volumes": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["container", "host", "mode", "description"],
            "properties": {
              "container": {
                "type": "string",
                "pattern": "^/[a-zA-Z0-9._/-]+$",
                "minLength": 2,
                "maxLength": 200
              },
              "host": {
                "type": "string",
                "pattern": "^(\\.?/[a-zA-Z0-9._-]+)+$|^\\$\\{[A-Z_]+\\}.*$",
                "minLength": 1,
                "maxLength": 200,
                "description": "Host path (relative ./path or absolute /path or variable ${VAR})"
              },
              "mode": {
                "type": "string",
                "enum": ["rw", "ro"]
              },
              "description": {
                "type": "string",
                "minLength": 3,
                "maxLength": 100
              }
            }
          },
          "minItems": 1,
          "maxItems": 20
        },
        "environment": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "description", "required"],
            "properties": {
              "name": {
                "type": "string",
                "pattern": "^[A-Za-z][A-Za-z0-9_]*$",
                "minLength": 1,
                "maxLength": 64,
                "description": "Environment variable name"
              },
              "value": {
                "type": "string",
                "maxLength": 1000,
                "description": "Default value (empty string for secrets user must provide)"
              },
              "required": {
                "type": "boolean",
                "description": "Whether this variable must be set by user"
              },
              "description": {
                "type": "string",
                "minLength": 3,
                "maxLength": 200
              }
            }
          },
          "maxItems": 50
        },
        "networks": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_-]*$"
          },
          "maxItems": 5,
          "uniqueItems": true,
          "description": "Docker networks to join"
        },
        "capabilities": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["NET_ADMIN", "NET_RAW", "SYS_ADMIN", "SYS_PTRACE", "SYS_TIME", "NET_BIND_SERVICE"]
          },
          "maxItems": 6,
          "uniqueItems": true,
          "description": "Linux capabilities (use sparingly)"
        },
        "privileged": {
          "type": "boolean",
          "const": false,
          "description": "Privileged mode (must be false)"
        },
        "restart": {
          "type": "string",
          "enum": ["no", "always", "on-failure", "unless-stopped"],
          "default": "unless-stopped"
        }
      }
    },
    "requirements": {
      "type": "object",
      "additionalProperties": false,
      "required": ["memory", "cpu", "storage"],
      "properties": {
        "memory": {
          "type": "string",
          "pattern": "^(12[89]|1[3-9][0-9]|[2-9][0-9]{2}|[1-9][0-9]{3,4})MB$|^([1-9]|[1-5][0-9]|6[0-4])GB$",
          "description": "Minimum RAM (128MB-64GB)"
        },
        "cpu": {
          "type": "string",
          "pattern": "^(0\\.[1-9]|[1-9](\\.[0-9])?|1[0-6])$",
          "description": "Minimum CPU cores (0.1-16)"
        },
        "storage": {
          "type": "string",
          "pattern": "^([1-9][0-9]{0,2}|[1-9][0-9]{3})MB$|^([1-9][0-9]{0,2})GB$|^([1-9])TB$",
          "description": "Minimum storage (1MB-9TB)"
        },
        "arch": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["amd64", "arm64", "arm/v7"]
          },
          "minItems": 1,
          "uniqueItems": true,
          "description": "Supported architectures"
        }
      }
    },
    "featured": {
      "type": "boolean",
      "description": "Whether the app is featured on the homepage"
    },
    "deprecated": {
      "type": "boolean",
      "description": "Whether the app is deprecated"
    },
    "maintainers": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^@[a-zA-Z0-9_-]+$",
        "description": "GitHub username with @ prefix"
      },
      "minItems": 1,
      "maxItems": 5,
      "uniqueItems": true,
      "description": "GitHub usernames of maintainers"
    },
    "screenshots": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["url", "alt"],
        "properties": {
          "url": {
            "type": "string",
            "format": "uri",
            "pattern": "^https://.*\\.(png|jpg|jpeg|webp|gif)$",
            "description": "HTTPS URL to screenshot image"
          },
          "alt": {
            "type": "string",
            "minLength": 5,
            "maxLength": 100,
            "description": "Alt text describing the screenshot"
          }
        }
      },
      "minItems": 1,
      "maxItems": 5,
      "description": "Screenshots of the app UI (1-5 images)"
    },
    "healthcheck": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "endpoint": {
          "type": "string",
          "pattern": "^/.*$",
          "description": "HTTP endpoint path for health check (e.g., /health, /api/health)"
        },
        "port": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535,
          "description": "Port to check (defaults to first exposed port)"
        },
        "protocol": {
          "type": "string",
          "enum": ["http", "https", "tcp"],
          "default": "http",
          "description": "Protocol for health check"
        },
        "interval": {
          "type": "integer",
          "minimum": 5,
          "maximum": 300,
          "default": 30,
          "description": "Check interval in seconds"
        },
        "timeout": {
          "type": "integer",
          "minimum": 1,
          "maximum": 60,
          "default": 10,
          "description": "Timeout in seconds"
        },
        "retries": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 3,
          "description": "Number of retries before marking unhealthy"
        }
      },
      "description": "Health check configuration for monitoring app status"
    }
  }
}
